// vim: tw=72 sts=-1 sw=3 et cms=//%s

#include <stdint.h>  // int64_t, size_t
#include <stdio.h>   // printf
#include <stdlib.h>  // rand

// Cf. Figure 3.4 on page 17 of Drepper's article.  The results of
// profiling this program are heavily influenced by what other processes
// are active at the same time.  It's best to kill as many as possible;
// e.g. Firefox, which tends to always use some CPU time.

#define N 100000000  // 100 million

struct elem {
   struct elem *next;
} array[SIZE];

int main() {
   for (size_t i = 0; i < SIZE - 1; ++i) array[i].next = &array[i + 1];
   array[SIZE - 1].next = array;
   // Fisher-Yates shuffle the array.
   for (size_t i = 0; i < SIZE - 1; ++i) {
      size_t j = i + rand() % (SIZE - i);  // j is in [i, SIZE).
      struct elem temp = array[i];  // Swap array[i] and array[j].
      array[i] = array[j];
      array[j] = temp;
   }
#ifndef BASELINE
   int64_t dummy = 0;
   struct elem *i = array;
   for (size_t n = 0; n < N; ++n) {
      dummy += (int64_t)i;
      i = i->next;
   }
   printf("%d\n", dummy);
#endif
}
